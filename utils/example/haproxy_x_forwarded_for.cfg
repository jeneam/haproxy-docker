defaults
  mode http
  timeout connect 4000ms
  timeout client 50000ms
  timeout server 50000ms

  stats enable
  stats refresh 5s
  stats show-node
  stats uri  /stats/haproxy

global
  log 127.0.0.1:1514 local0 debug
  user haproxy
  group haproxy

frontend fe_app
  log global
  log-format "%ci:%cp [%t] %ft %b/%s %Tq/%Tw/%Tc/%Tr/%Tt %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs {%[ssl_c_verify],%{+Q}[ssl_c_s_dn],%{+Q}[ssl_c_i_dn]} %{+Q}r"

  # Check restricted network
  acl restricted_network src 90.80.70.60 # Home network
  acl restricted_network hdr_ip(X-Forwarded-For) -f /etc/haproxy/acl_restricted_network

  use_backend blocked-proxy-ua if !restricted_network

  reqadd Referer:\ http://zorba.admin.ch

  bind 0.0.0.0:8080 name http
 
  default_backend be_app_stable

  
 backend blocked-proxy-ua
      mode http
      errorfile 503 /var/local/503.http


backend be_app_stable
  log global
  http-request replace-value Host .* api3.geo.admin.ch
  server upstream_server api3.geo.admin.ch:80 maxconn 512

